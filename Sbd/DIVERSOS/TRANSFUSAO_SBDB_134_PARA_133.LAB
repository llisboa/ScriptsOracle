[001]
net use \\10.0.4.11\C$ "XXXXXXXXXXX" /USER:ADMINISTRADOR
SYNCDOS -DIR C:\oracle\flash_recovery_area\SBDB -REPL \\10.0.4.11\c$\oracle\flash_recovery_area\SBDB -SEMCONFIRM > C:\TRANSFUSAO_SBDB_134_PARA_133.LOG

[002]
ECHO SHUTDOWN ABORT | SQLPLUS SYS/XXXX@SBDB_133 AS SYSDBA 
DEL \\10.0.4.11\c$\oracle\product\11.2.0\oradata\SBDB /Q
ECHO STARTUP NOMOUNT | SQLPLUS SYS/XXXX@SBDB_133 AS SYSDBA
RMAN.EXE TARGET 'SYS/XXXX@SBDB_133 AS SYSDBA' @==[RMAN_SCRIPT]
SQLPLUS SYS/XXXX@SBDB_133 AS SYSDBA @==[SQL_SCRIPT]

[RMAN_SCRIPT]
RESTORE CONTROLFILE FROM '\\10.0.4.11\c$\oracle\flash_recovery_area\SBDB\AUTOBACKUP\==ultimodirn\==ultimoarqc';
ALTER DATABASE MOUNT;
run {
CONFIGURE CONTROLFILE AUTOBACKUP OFF;
configure device type disk parallelism 1;
configure default device type to disk;
configure channel 1 device type disk format '\\10.0.4.11\C$\oracle\flash_recovery_area\SBDB\BACKUP_ORACLE\RMAN_DISK\1\%d_%T_%s_%t_F.BKP';
#crosscheck archivelog all;
crosscheck backupset;
SET UNTIL TIME 'SYSDATE-6';
RESTORE DATABASE;
RECOVER DATABASE;
}
EXIT;

[SQL_SCRIPT]
SHUTDOWN NORMAL; 
STARTUP MOUNT;
alter system set db_recovery_file_dest_size=20G scope=both;
ALTER DATABASE OPEN RESETLOGS; 
SHUTDOWN ABORT; 
STARTUP RESTRICT;
SET SERVEROUTPUT ON SIZE 40000
SET HEADING OFF;
SET ECHO OFF;

BEGIN
	FOR JOB IN (SELECT JOB,WHAT FROM DBA_JOBS) LOOP
		BEGIN
		DBMS_OUTPUT.PUT_LINE('BROKEN EM JOB ' || JOB.JOB || ' - ' || JOB.WHAT);
	 	SYS.dbms_ijob.BROKEN(JOB.JOB,TRUE);
		EXCEPTION
		WHEN OTHERS THEN
			DBMS_OUTPUT.PUT_LINE('==> ERRO:' || SQLERRM);
		END;
	END LOOP;
END;
/

DECLARE
  COMA VARCHAR2(4000);
 BEGIN
   FOR CUR IN
  (SELECT OWNER, TABLE_NAME FROM ALL_TABLES WHERE OWNER IN (SELECT USERNAME FROM ALL_USERS WHERE CREATED >= (SELECT CREATED FROM ALL_USERS WHERE USERNAME IN ('SBDB')  ))
  )
  LOOP
    IF INSTR(';SYS_CONFIG_USUARIO;', ';' || CUR.TABLE_NAME || ';')=0 THEN
      COMA                                                       := 'ALTER TABLE ' || CUR.OWNER || '.' || CUR.TABLE_NAME || ' READ ONLY';
      DBMS_OUTPUT.PUT_LINE(COMA);
      BEGIN
        EXECUTE IMMEDIATE COMA;
      EXCEPTION
      WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('==> ERRO:' || SQLERRM);
      END;
    END IF;
  END LOOP;
 END; 
/
COMMIT;
/

SELECT 'SCN MAIS RECENTE: ' || TO_CHAR(SCN_TO_TIMESTAMP(CURRENT_SCN),'YYYY-MM-DD HH24:MI:SS') SCN FROM V$DATABASE;
SELECT 'MANUT ULT MOMENTO: ' || TO_CHAR(SBDB.DBMS_ICRAFT.MANUT_ULTIMO_MOMENTO('SBDB'),'YYYY-MM-DD HH24:MI:SS') TAB_ALTERA FROM DUAL;
SELECT 'ULTIMA ATUALIZACAO NO SOCIO: ' || TO_CHAR(MAX(NVL(SYS_MOMENTO_ATUALIZA,SYS_MOMENTO_CRIA)),'YYYY-MM-DD HH24:MI:SS') FROM SBDB."SÓCIO";
SELECT 'SERVIDOR: ' || MACHINE FROM V$SESSION WHERE PROGRAM = 'ORACLE.EXE (MMAN)';
SELECT 'ID DA BASE: ' || DBID FROM V$DATABASE; 

ALTER SYSTEM DISABLE RESTRICTED SESSION;
EXIT;
