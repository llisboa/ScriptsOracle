create or replace package  REL_COMP_SINT_CORP is

procedure país(DATA_INI1 in varchar2 ,DATA_FIM1 in varchar2 ,DATA_INI2 in varchar2 ,DATA_FIM2 in varchar2, USUARIOP in varchar2, ESCRITÓRIOP in varchar2 , MODALIDADEP in varchar2 ,DIVISÃOP in varchar2 , SUBDIVISP in varchar2 , FORNECP in varchar2 , COMPRADORP in varchar2 , PAÍSESP in varchar2, POSICAOP in varchar2, PEDIDOINIP in varchar2, PEDIDOFIMP in varchar2);
procedure fornecedor(DATA_INI1 in varchar2 ,DATA_FIM1 in varchar2 ,DATA_INI2 in varchar2 ,DATA_FIM2 in varchar2, USUARIOP in varchar2, ESCRITÓRIOP in varchar2 , MODALIDADEP in varchar2 ,DIVISÃOP in varchar2 , SUBDIVISP in varchar2 , FORNECP in varchar2 , COMPRADORP in varchar2 , PAÍSESP in varchar2, POSICAOP in varchar2, PEDIDOINIP in varchar2, PEDIDOFIMP in varchar2);

end REL_COMP_SINT_CORP;
/

create or replace package body REL_COMP_SINT_CORP is

procedure país(DATA_INI1 in varchar2 ,DATA_FIM1 in varchar2 ,DATA_INI2 in varchar2 ,DATA_FIM2 in varchar2, USUARIOP in varchar2, ESCRITÓRIOP in varchar2 , MODALIDADEP in varchar2 ,DIVISÃOP in varchar2 , SUBDIVISP in varchar2 , FORNECP in varchar2 , COMPRADORP in varchar2 , PAÍSESP in varchar2, POSICAOP in varchar2, PEDIDOINIP in varchar2, PEDIDOFIMP in varchar2) is
	USUARIO    varchar2(30);
	ESCRITÓRIO varchar2(15);
	MODALIDADE varchar2(15);
	DIVISÃO    varchar2(15);
	SUBDIVIS   varchar2(15);
	FORNEC     varchar2(30);
	COMPRADOR  varchar2(30);
	PAÍSES     varchar2(25);
	SITUACAO   varchar2(10);
	POSICAO    varchar2(1);
	PEDIDOINI  varchar2(15);
	PEDIDOFIM  varchar2(15);
begin
--VERIFICAÇÃO DOS PARÂMENTROS
	USUARIO   := USUARIOP;
	ESCRITÓRIO:= ESCRITÓRIOP;
	MODALIDADE:= MODALIDADEP;
	DIVISÃO   := DIVISÃOP;
	SUBDIVIS  := SUBDIVISP;
	FORNEC    := FORNECP;
	COMPRADOR := COMPRADORP;
	PAÍSES    := PAÍSESP;
	POSICAO   := POSICAOP;
	PEDIDOINI := PEDIDOINIP;
	PEDIDOFIM := PEDIDOFIMP;
if USUARIO = '0' THEN
	USUARIO := '%';
END IF;
if ESCRITÓRIO = '0' THEN
	ESCRITÓRIO := '%';
END IF;
if MODALIDADE = '0' THEN
	MODALIDADE := '%';
END IF;
if DIVISÃO = '0' THEN
	DIVISÃO := '%';
END IF;
if SUBDIVIS = '0' THEN
	SUBDIVIS := '%';
END IF;
if FORNEC = '0' THEN
	FORNEC := '%';
END IF;
if COMPRADOR = '0' THEN
	COMPRADOR := '%';
END IF;
if PAÍSES = '0' THEN
	PAÍSES := '%';
END IF;
if POSICAO = '%' THEN
	SITUACAO:= 'XXX';
ELSIF POSICAO = 'A' OR POSICAO = 'F' THEN
	SITUACAO := 'NULO';
END IF;
if PEDIDOINI = '0' THEN
	PEDIDOINI:='A';
END IF;
if PEDIDOFIM = '0' THEN
	PEDIDOFIM:='Z';
END IF;

--PEDIDO--BOOKINGS
delete from CXRJ.REL_CSC_PAÍS_FORN_PEDIDO;
commit;
for cur_ped in (
SELECT
PED.PAÍS_DESTINO,
INSTR('BH;SP;RJ',SUBSTR(PED.REF,1,2)) ORDEM,
SUBSTR(PED.REF,1,2) ESCRIT,
SUBSTR(PED.REF,4,1) DIV,
SUM(NVL(RESULT_UNION.QTD1,0)) QTD1,
SUM(NVL(RESULT_UNION.QTD2,0)) QTD2,
SUM(NVL(RESULT_UNION.PR1,0)) PR1,
SUM(NVL(RESULT_UNION.PR2,0)) PR2,
SUM(NVL(RESULT_UNION.RES1,0)) RES1,
SUM(NVL(RESULT_UNION.RES2,0)) RES2
FROM
(SELECT
    REF,
    PED_DATA,
    QTD1,
    0 QTD2,
    PR1,
    0 PR2,
    RES1,
    0 RES2
  FROM
     (
	SELECT
        PED.REF,
        PED.PED_DATA,
        SUM(NVL(PED_ITEM.NOMINAL_MT,0)) QTD1,
        NVL(PED.TAXA_USD,1) * SUM(NVL(NOMINAL_PED_UNID,0) * NVL(PREÇO_UNITÁRIO_FORNECEDOR,0)) PR1 ,
        DECODE(PED.F_RESULTADO,NULL,NVL(PED.TAXA_USD,1) * NVL(PED.F_RESULTADO_P,0) * NVL(SUM(NVL(NOMINAL_PED_UNID,0) * NVL(PREÇO_UNITÁRIO_FORNECEDOR,0)),0) / 100,PED.F_RESULTADO) RES1
     FROM
        PED,
-- RETIRADO PELO HOTT EM 20/11/2008
--      EMB_F,
        PED_ITEM,
        CIA CIAU,
        CIA CIAF,
        CIA CIAI
     WHERE
        PED.REF = PED_ITEM.PED_REF AND
-- RETIRADO PELO HOTT EM 20/11/2008
--      PED_ITEM.PED_REF = EMB_F.PED_REF  AND
	PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
	PED.FORNECEDOR = CIAF.COD(+) AND
        PED.IMP = CIAI.COD(+) AND
        INSTR('BH;SP;RJ', SUBSTR(PED_ITEM.PED_REF,1,2)) > 0 AND
-- RETIRADO PELO HOTT EM 20/11/2008
--     NVL(EMB_F.POSIÇÃO,'A') LIKE POSICAO AND
            PED.REF LIKE ESCRITÓRIO AND
            PED.REF LIKE MODALIDADE AND
            PED.REF LIKE DIVISÃO AND
            PED.REF LIKE SUBDIVIS AND
            DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
            DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
            PED.PED_DATA >= TO_DATE(DATA_INI1,'DD/MM/YYYY') AND
            PED.PED_DATA <= TO_DATE(DATA_FIM1,'DD/MM/YYYY') AND
            NVL(PED.PAÍS_DESTINO,'%') LIKE PAÍSES AND
            NVL(CIAU.F_COD,'%') LIKE USUARIO AND
            NVL(CIAF.F_COD,'%') LIKE FORNEC  AND
            NVL(CIAI.F_COD,'%') LIKE COMPRADOR
     GROUP BY
        PED.REF,
        PED.TAXA_USD,
	PED.PED_DATA,
-- RETIRADO PELO HOTT EM 20/11/2008
--        EMB_F.SEQ,
--        DECODE(EMB_F.PED_REF,NULL,'NULO','EXISTE'),
--        NVL(EMB_F.POSIÇÃO,'A'),
        PED.F_RESULTADO,
        PED.F_RESULTADO_P
     )RESULT_PARCIAL
  GROUP BY
    REF,
    PED_DATA,
    QTD1,
    PR1,
    RES1
UNION ALL
  SELECT
    REF,
    PED_DATA,
    0 QTD1,
    QTD2,
    0 PR1,
    PR2,
    0 RES1,
    RES2
  FROM
     (
     SELECT
        PED.REF,
        PED.PED_DATA,
        SUM(NVL(PED_ITEM.NOMINAL_MT,0)) QTD2,
        NVL(PED.TAXA_USD,1) * SUM(NVL(NOMINAL_PED_UNID,0) * NVL(PREÇO_UNITÁRIO_FORNECEDOR,0)) PR2 ,
        NVL(PED.TAXA_USD,1) * DECODE(PED.F_RESULTADO,NULL,NVL(PED.F_RESULTADO_P,0) * NVL(SUM(NVL(NOMINAL_PED_UNID,0) * NVL(PREÇO_UNITÁRIO_FORNECEDOR,0)),0) / 100,PED.F_RESULTADO) RES2
     FROM
        PED,
-- RETIRADO PELO HOTT EM 20/11/2008
--      EMB_F,
        PED_ITEM,
        CIA CIAU,
        CIA CIAF,
        CIA CIAI
     WHERE
        PED.REF = PED_ITEM.PED_REF AND
-- RETIRADO PELO HOTT EM 20/11/2008
--      PED_ITEM.PED_REF = EMB_F.PED_REF  AND
	PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
	PED.FORNECEDOR = CIAF.COD(+) AND
        PED.IMP = CIAI.COD(+) AND
        INSTR('BH;SP;RJ', SUBSTR(PED_ITEM.PED_REF,1,2)) > 0 AND
-- RETIRADO PELO HOTT EM 20/11/2008
--  	    NVL(EMB_F.POSIÇÃO,'A') LIKE POSICAO AND
            PED.REF LIKE ESCRITÓRIO AND
            PED.REF LIKE MODALIDADE AND
            PED.REF LIKE DIVISÃO AND
            PED.REF LIKE SUBDIVIS AND
            DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
            DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
            PED.PED_DATA >= TO_DATE(DATA_INI2,'DD/MM/YYYY') AND
            PED.PED_DATA <= TO_DATE(DATA_FIM2,'DD/MM/YYYY') AND
            NVL(PED.PAÍS_DESTINO,'%') LIKE PAÍSES AND
            NVL(CIAU.F_COD,'%') LIKE USUARIO AND
            NVL(CIAF.F_COD,'%') LIKE FORNEC  AND
            NVL(CIAI.F_COD,'%') LIKE COMPRADOR
     GROUP BY
        PED.REF,
        PED.TAXA_USD,
	PED.PED_DATA,
-- RETIRADO PELO HOTT EM 20/11/2008
--        EMB_F.SEQ,
--        DECODE(EMB_F.PED_REF,NULL,'NULO','EXISTE'),
--        NVL(EMB_F.POSIÇÃO,'A'),
        PED.F_RESULTADO,
        PED.F_RESULTADO_P
     )RESULT_PARCIAL
  GROUP BY
    REF,
    PED_DATA,
    QTD2,
    PR2,
    RES2
  )RESULT_UNION,
 PED
WHERE
  RESULT_UNION.REF = PED.REF
GROUP BY
  PED.PAÍS_DESTINO,
  INSTR('BH;SP;RJ', SUBSTR(PED.REF,1,2)),
  SUBSTR(PED.REF,1,2), SUBSTR(PED.REF,4,1)
ORDER BY
  PED.PAÍS_DESTINO,
  ORDEM
) loop
	insert into CXRJ.REL_CSC_PAÍS_FORN_PEDIDO (CHAVE, ORDEM, ESCRIT, DIV,QTD1, QTD2, PR1, PR2, RES1,RES2) VALUES (CUR_PED.PAÍS_DESTINO, CUR_PED.ORDEM, CUR_PED.ESCRIT, CUR_PED.DIV,CUR_PED.QTD1, CUR_PED.QTD2, CUR_PED.PR1, CUR_PED.PR2, CUR_PED.RES1,CUR_PED.RES2);
end loop;
commit;

--EMBARQUE SHIPMENTS
delete from CXRJ.REL_CSC_PAÍS_FORN_EMBARQUE;
commit;
for cur_emb in (
SELECT
  RESULT_UNION.PAÍS PAÍS_DESTINO,
  INSTR('BH;SP;RJ', ESCRIT) ORDEM,
  ESCRIT,
  DIV,
  SUM(NVL(QTD1,0)) QTD1,
  SUM(NVL(QTD2,0)) QTD2,
  SUM(NVL(PR1,0)) PR1,
  SUM(NVL(PR2,0)) PR2,
  SUM(NVL(RES1,0)) RES1,
  SUM(NVL(RES2,0)) RES2
FROM
       (
        SELECT
	  USU.PAÍS_DESTINO PAÍS,
	  SUBSTR(EMB_F.PED_REF,1,2) ESCRIT,
	  SUBSTR(EMB_F.PED_REF,3,1) TIPO,
	  SUBSTR(EMB_F.PED_REF,4,1) DIV,
	  EMB_F.QUANTIDADE QTD1,
	  0 QTD2,
	  EMB_F.VALOR PR1,
	  0 PR2,
	  (NVL(EMB_F.RESULT1,0) + NVL(EMB_F.RESULT2,0) + NVL(EMB_F.RESULT3,0) + NVL(EMB_F.RESULT4,0) + NVL(EMB_F.RESULT5,0) )RES1,
	  0 RES2
        FROM
               (
 		SELECT
		  PED.REF, PED.PAÍS_DESTINO
		FROM
		   PED_ITEM, PED, CIA CIAF, CIA CIAU, CIA CIAI
		WHERE
		   PED.REF = PED_ITEM.PED_REF     AND
		   PED.REF LIKE ESCRITÓRIO        AND
		   PED.REF LIKE MODALIDADE        AND
		   PED.REF LIKE DIVISÃO           AND
		   PED.REF LIKE SUBDIVIS          AND
	           PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
		   PED.FORNECEDOR = CIAF.COD(+) AND
                   PED.IMP = CIAI.COD(+) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
		   NVL(CIAF.F_COD,'%') like FORNEC AND
                   NVL(CIAI.F_COD,'%') like COMPRADOR AND
		   NVL(CIAU.F_COD,'%') like USUARIO AND
   	   	   NVL(PED.PAÍS_DESTINO,'%') like PAÍSES
		GROUP BY
                   PED.REF, PED.PAÍS_DESTINO
               )USU, EMB_F
        WHERE
          USU.REF = EMB_F.PED_REF                         AND
          EMB_F.BL_DATA >=TO_DATE(DATA_INI1,'DD/MM/YYYY') AND
          EMB_F.BL_DATA <=TO_DATE(DATA_FIM1,'DD/MM/YYYY')
UNION ALL
        SELECT
	  USU.PAÍS_DESTINO PAÍS,
	  SUBSTR(EMB_F.PED_REF,1,2) ESCRIT,
	  SUBSTR(EMB_F.PED_REF,3,1) TIPO,
	  SUBSTR(EMB_F.PED_REF,4,1) DIV,
	  0 QTD1,
	  EMB_F.QUANTIDADE QTD2,
	  0 PR1,
	  EMB_F.VALOR PR2,
	  0 RES1,
	  (NVL(EMB_F.RESULT1,0) + NVL(EMB_F.RESULT2,0) + NVL(EMB_F.RESULT3,0) + NVL(EMB_F.RESULT4,0) + NVL(EMB_F.RESULT5,0) )RES2
        FROM
               (
 		SELECT
		  PED.REF, PED.PAÍS_DESTINO
		FROM
		   PED_ITEM, PED, CIA CIAF, CIA CIAU, CIA CIAI
		WHERE
		   PED.REF = PED_ITEM.PED_REF     AND
		   PED.REF LIKE ESCRITÓRIO        AND
		   PED.REF LIKE MODALIDADE        AND
		   PED.REF LIKE DIVISÃO           AND
		   PED.REF LIKE SUBDIVIS          AND
	           PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
		   PED.FORNECEDOR = CIAF.COD(+) AND
                   PED.IMP = CIAI.COD(+) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
		   NVL(CIAF.F_COD,'%') like FORNEC AND
                   NVL(CIAI.F_COD,'%') like COMPRADOR AND
		   NVL(CIAU.F_COD,'%') like USUARIO AND
   	   	   NVL(PED.PAÍS_DESTINO,'%') like PAÍSES
		GROUP BY
                   PED.REF, PED.PAÍS_DESTINO
               )USU, EMB_F
        WHERE
          USU.REF = EMB_F.PED_REF                         AND
          EMB_F.BL_DATA >=TO_DATE(DATA_INI2,'DD/MM/YYYY') AND
          EMB_F.BL_DATA <=TO_DATE(DATA_FIM2,'DD/MM/YYYY')
       ) RESULT_UNION
WHERE
  RESULT_UNION.TIPO = 'P' OR
  RESULT_UNION.TIPO = 'C'
GROUP BY
  PAÍS,
  ESCRIT,
  DIV
HAVING NOT
  (
  SUM(NVL(QTD1,0)) =0 AND
  SUM(NVL(QTD2,0)) =0 AND
  SUM(NVL(PR1,0)) =0 AND
  SUM(NVL(PR2,0)) =0 AND
  SUM(NVL(RES1,0)) =0 AND
  SUM(NVL(RES2,0)) =0)
ORDER BY
  RESULT_UNION.PAÍS,
  ESCRIT
)loop
	insert into CXRJ.REL_CSC_PAÍS_FORN_EMBARQUE (CHAVE, ORDEM, ESCRIT, DIV,QTD1, QTD2, PR1, PR2, RES1,RES2) VALUES (CUR_emb.PAÍS_DESTINO, CUR_emb.ORDEM, CUR_emb.ESCRIT, CUR_emb.DIV,CUR_emb.QTD1, CUR_emb.QTD2, CUR_emb.PR1, CUR_emb.PR2, CUR_emb.RES1,CUR_emb.RES2);
end loop;
commit;

-- RESULT
delete from CXRJ.REL_CSC_PAÍS_FORN_RESULT;
commit;
for cur_result in (
SELECT
  R.PAÍS PAÍS_DESTINO,
  INSTR('BH;SP;RJ', SUBSTR(R.PED_REF,1,2)) AS ORDEM,
  SUBSTR(R.PED_REF,1,2) ESCRIT,
  SUBSTR(R.PED_REF,4,1) DIV,
  SUM(R.R1) RES1 ,
  SUM(R.R2) RES2
FROM
        (
        SELECT
	   USU.PAÍS_DESTINO PAÍS,
	   RV.PED_REF,
	   RV.EMB_SEQ,
	   RV.SEQ,
	   NVL(RV.RES,0) R1,
	   0 R2
	FROM
              (
 		SELECT
		  PED.REF, PED.PAÍS_DESTINO
		FROM
		   PED_ITEM, PED, CIA CIAF, CIA CIAU, CIA CIAI
		WHERE
		   PED.REF = PED_ITEM.PED_REF     AND
		   PED.REF LIKE ESCRITÓRIO        AND
		   PED.REF LIKE MODALIDADE        AND
		   PED.REF LIKE DIVISÃO           AND
		   PED.REF LIKE SUBDIVIS          AND
	           PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
		   PED.FORNECEDOR = CIAF.COD(+) AND
                   PED.IMP = CIAI.COD(+) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
		   NVL(CIAF.F_COD,'%') like FORNEC AND
                   NVL(CIAI.F_COD,'%') like COMPRADOR AND
		   NVL(CIAU.F_COD,'%') like USUARIO AND
   	   	   NVL(PED.PAÍS_DESTINO,'%') like PAÍSES
		GROUP BY
                   PED.REF, PED.PAÍS_DESTINO
               )USU, RESULT_VERTICAL RV, EMB_F
	WHERE
		USU.REF = RV.PED_REF AND
		RV.PED_REF = EMB_F.PED_REF  AND
		RV.EMB_SEQ = EMB_F.SEQ  AND
		RV.DT >=TO_DATE(DATA_INI1,'DD/MM/YYYY') AND
		RV.DT <=TO_DATE(DATA_FIM1,'DD/MM/YYYY')
UNION ALL
	SELECT
	   USU.PAÍS_DESTINO PAÍS,
	   RV.PED_REF,
	   RV.EMB_SEQ,
	   RV.SEQ,
	   0 R1,
	   NVL(RV.RES,0) R2
	FROM
              (
 		SELECT
		  PED.REF, PED.PAÍS_DESTINO
		FROM
		   PED_ITEM, PED, CIA CIAF, CIA CIAU, CIA CIAI
		WHERE
		   PED.REF = PED_ITEM.PED_REF     AND
		   PED.REF LIKE ESCRITÓRIO        AND
		   PED.REF LIKE MODALIDADE        AND
		   PED.REF LIKE DIVISÃO           AND
		   PED.REF LIKE SUBDIVIS          AND
	           PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
		   PED.FORNECEDOR = CIAF.COD(+) AND
                   PED.IMP = CIAI.COD(+) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
		   NVL(CIAF.F_COD,'%') like FORNEC AND
                   NVL(CIAI.F_COD,'%') like COMPRADOR AND
		   NVL(CIAU.F_COD,'%') like USUARIO AND
   	   	   NVL(PED.PAÍS_DESTINO,'%') like PAÍSES
		GROUP BY
                   PED.REF, PED.PAÍS_DESTINO
               )USU, RESULT_VERTICAL RV, EMB_F
	WHERE
		USU.REF = RV.PED_REF AND
		RV.PED_REF = EMB_F.PED_REF  AND
		RV.EMB_SEQ = EMB_F.SEQ  AND
		RV.DT >=TO_DATE(DATA_INI2,'DD/MM/YYYY') AND
		RV.DT <=TO_DATE(DATA_FIM2,'DD/MM/YYYY')
			)R
GROUP BY
	R.PAÍS,
	SUBSTR(R.PED_REF,1,2),
	SUBSTR(R.PED_REF,4,1)
HAVING NOT (SUM(NVL(R1,0)) =0 AND SUM(NVL(R2,0)) =0)
) loop
	insert into CXRJ.REL_CSC_PAÍS_FORN_RESULT (CHAVE, ORDEM, ESCRIT, DIV,RES1,RES2) VALUES (cur_result.PAÍS_DESTINO, cur_result.ORDEM, cur_result.ESCRIT, cur_result.DIV, cur_result.RES1,cur_result.RES2);
	end loop;
	commit;
end país;

procedure fornecedor(DATA_INI1 in varchar2 ,DATA_FIM1 in varchar2 ,DATA_INI2 in varchar2 ,DATA_FIM2 in varchar2, USUARIOP in varchar2, ESCRITÓRIOP in varchar2 , MODALIDADEP in varchar2 ,
DIVISÃOP in varchar2 , SUBDIVISP in varchar2 , FORNECP in varchar2 , COMPRADORP in varchar2 , PAÍSESP in varchar2, POSICAOP in varchar2, PEDIDOINIP in varchar2, PEDIDOFIMP in varchar2) is
	USUARIO    varchar2(30);
	ESCRITÓRIO varchar2(15);
	MODALIDADE varchar2(15);
	DIVISÃO    varchar2(15);
	SUBDIVIS   varchar2(15);
	FORNEC     varchar2(30);
	COMPRADOR  varchar2(30);
	PAÍSES     varchar2(25);
	SITUACAO   varchar2(10);
	POSICAO    varchar2(1);
	PEDIDOINI  varchar2(15);
	PEDIDOFIM  varchar2(15);
begin
--VERIFICAÇÃO DOS PARÂMENTROS
	USUARIO   := USUARIOP;
	ESCRITÓRIO:= ESCRITÓRIOP;
	MODALIDADE:= MODALIDADEP;
	DIVISÃO   := DIVISÃOP;
	SUBDIVIS  := SUBDIVISP;
	FORNEC    := FORNECP;
	COMPRADOR := COMPRADORP;
	PAÍSES    := PAÍSESP;
	POSICAO   := POSICAOP;
	PEDIDOINI := PEDIDOINIP;
	PEDIDOFIM := PEDIDOFIMP;
if USUARIO = '0' THEN
	USUARIO := '%';
END IF;
if ESCRITÓRIO = '0' THEN
	ESCRITÓRIO := '%';
END IF;
if MODALIDADE = '0' THEN
	MODALIDADE := '%';
END IF;
if DIVISÃO = '0' THEN
	DIVISÃO := '%';
END IF;
if SUBDIVIS = '0' THEN
	SUBDIVIS := '%';
END IF;
if FORNEC = '0' THEN
	FORNEC := '%';
END IF;
if COMPRADOR = '0' THEN
	COMPRADOR := '%';
END IF;
if PAÍSES = '0' THEN
	PAÍSES := '%';
END IF;
if POSICAO = '%' THEN
	SITUACAO:= 'XXX';
ELSIF POSICAO = 'A' OR POSICAO = 'F' THEN
	SITUACAO := 'NULO';
END IF;
if PEDIDOINI = '0' THEN
	PEDIDOINI:='A';
END IF;
if PEDIDOFIM = '0' THEN
	PEDIDOFIM:='Z';
END IF;
--PEDIDO--BOOKINGS
delete from CXRJ.REL_CSC_PAÍS_FORN_PEDIDO;
commit;

for cur_ped in (SELECT
PED.FORNECEDOR,
INSTR('BH;SP;RJ',SUBSTR(PED.REF,1,2)) ORDEM,
SUBSTR(PED.REF,1,2) ESCRIT,
SUBSTR(PED.REF,4,1) DIV,
SUM(NVL(RESULT_UNION.QTD1,0)) QTD1,
SUM(NVL(RESULT_UNION.QTD2,0)) QTD2,
SUM(NVL(RESULT_UNION.PR1,0)) PR1,
SUM(NVL(RESULT_UNION.PR2,0)) PR2,
SUM(NVL(RESULT_UNION.RES1,0)) RES1,
SUM(NVL(RESULT_UNION.RES2,0)) RES2
FROM
(SELECT
    REF,
    PED_DATA,
    QTD1,
    0 QTD2,
    PR1,
    0 PR2,
    RES1,
    0 RES2
  FROM
     (
	SELECT
        PED.REF,
        PED.PED_DATA,
        SUM(NVL(PED_ITEM.NOMINAL_MT,0)) QTD1,
        NVL(PED.TAXA_USD,1) * SUM(NVL(NOMINAL_PED_UNID,0) * NVL(PREÇO_UNITÁRIO_FORNECEDOR,0)) PR1 ,
        NVL(PED.TAXA_USD,1) * DECODE(PED.F_RESULTADO,NULL,NVL(PED.F_RESULTADO_P,0) * NVL(SUM(NVL(NOMINAL_PED_UNID,0) * NVL(PREÇO_UNITÁRIO_FORNECEDOR,0)),0) / 100,PED.F_RESULTADO) RES1
     FROM
        PED,
-- RETIRADO PELO HOTT EM 31/10/2008
--      EMB_F,
        PED_ITEM,
        CIA CIAU,
        CIA CIAF,
        CIA CIAI
     WHERE
        PED.REF = PED_ITEM.PED_REF AND
-- RETIRADO PELO HOTT EM 31/10/2008
--      PED_ITEM.PED_REF = EMB_F.PED_REF  AND
	PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
	PED.FORNECEDOR = CIAF.COD(+) AND
        PED.IMP = CIAI.COD(+) AND
        INSTR('BH;SP;RJ', SUBSTR(PED_ITEM.PED_REF,1,2)) > 0 AND
-- RETIRADO PELO HOTT EM 31/10/2008
--     NVL(EMB_F.POSIÇÃO,'A') LIKE POSICAO    AND
            PED.REF LIKE ESCRITÓRIO AND
            PED.REF LIKE MODALIDADE AND
            PED.REF LIKE DIVISÃO AND
            PED.REF LIKE SUBDIVIS AND
            DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
            DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
            PED.PED_DATA >= TO_DATE(DATA_INI1,'DD/MM/YYYY') AND
            PED.PED_DATA <= TO_DATE(DATA_FIM1,'DD/MM/YYYY') AND
            NVL(PED.PAÍS_DESTINO,'%') LIKE PAÍSES AND
            NVL(CIAU.F_COD,'%') LIKE USUARIO AND
            NVL(CIAF.F_COD,'%') LIKE FORNEC  AND
            NVL(CIAI.F_COD,'%') LIKE COMPRADOR
     GROUP BY
        PED.TAXA_USD,
	      PED.REF,
        PED.PED_DATA,
-- RETIRADO PELO HOTT EM 31/10/2008
--        EMB_F.SEQ,
        PED.F_RESULTADO,
        PED.F_RESULTADO_P
     )RESULT_PARCIAL
  GROUP BY
    REF,
    PED_DATA,
    QTD1,
    PR1,
    RES1
UNION ALL
  SELECT
    REF,
    PED_DATA,
    0 QTD1,
    QTD2,
    0 PR1,
    PR2,
    0 RES1,
    RES2
  FROM
     (
     SELECT
        PED.REF,
        PED.PED_DATA,
        SUM(NVL(PED_ITEM.NOMINAL_MT,0)) QTD2,
        NVL(PED.TAXA_USD,1) * SUM(NVL(NOMINAL_PED_UNID,0) * NVL(PREÇO_UNITÁRIO_FORNECEDOR,0)) PR2 ,
        NVL(PED.TAXA_USD,1) * DECODE(PED.F_RESULTADO,NULL,NVL(PED.F_RESULTADO_P,0) * NVL(SUM(NVL(NOMINAL_PED_UNID,0) * NVL(PREÇO_UNITÁRIO_FORNECEDOR,0)),0) / 100,PED.F_RESULTADO) RES2
     FROM
        PED,
-- RETIRADO PELO HOTT EM 31/10/2008
--      EMB_F,
        PED_ITEM,
        CIA CIAU,
        CIA CIAF,
        CIA CIAI
     WHERE
        PED.REF = PED_ITEM.PED_REF AND
-- RETIRADO PELO HOTT EM 31/10/2008
--      PED_ITEM.PED_REF = EMB_F.PED_REF  AND
	PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
	PED.FORNECEDOR = CIAF.COD(+) AND
        PED.IMP = CIAI.COD(+) AND
        INSTR('BH;SP;RJ', SUBSTR(PED_ITEM.PED_REF,1,2)) > 0 AND
-- RETIRADO PELO HOTT EM 31/10/2008
--            NVL(EMB_F.POSIÇÃO,'A') LIKE POSICAO AND
            PED.REF LIKE ESCRITÓRIO AND
            PED.REF LIKE MODALIDADE AND
            PED.REF LIKE DIVISÃO AND
            PED.REF LIKE SUBDIVIS AND
            DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
            DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
            PED.PED_DATA >= TO_DATE(DATA_INI2,'DD/MM/YYYY') AND
            PED.PED_DATA <= TO_DATE(DATA_FIM2,'DD/MM/YYYY') AND
            NVL(PED.PAÍS_DESTINO,'%') LIKE PAÍSES AND
            NVL(CIAU.F_COD,'%') LIKE USUARIO AND
            NVL(CIAF.F_COD,'%') LIKE FORNEC  AND
            NVL(CIAI.F_COD,'%') LIKE COMPRADOR
     GROUP BY
        PED.TAXA_USD,
	PED.REF,
        PED.PED_DATA,
-- RETIRADO PELO HOTT EM 31/10/2008
--        EMB_F.SEQ,
        PED.F_RESULTADO,
        PED.F_RESULTADO_P
     )RESULT_PARCIAL
  GROUP BY
    REF,
    PED_DATA,
    QTD2,
    PR2,
    RES2
  )RESULT_UNION,
 PED
WHERE
  RESULT_UNION.REF = PED.REF
GROUP BY
  PED.FORNECEDOR,
  INSTR('BH;SP;RJ', SUBSTR(PED.REF,1,2)),
  SUBSTR(PED.REF,1,2),
  SUBSTR(PED.REF,4,1)
ORDER BY
  PED.FORNECEDOR,
  ORDEM) loop
	select CIA.F_COD into CUR_PED.FORNECEDOR from CXRJ.CIA where CIA.COD = CUR_PED.FORNECEDOR;
	insert into CXRJ.REL_CSC_PAÍS_FORN_PEDIDO (CHAVE, ORDEM, ESCRIT, DIV,QTD1, QTD2, PR1, PR2, RES1,RES2) VALUES (CUR_PED.FORNECEDOR, CUR_PED.ORDEM, CUR_PED.ESCRIT, CUR_PED.DIV,CUR_PED.QTD1, CUR_PED.QTD2, CUR_PED.PR1, CUR_PED.PR2, CUR_PED.RES1,CUR_PED.RES2);
end loop;
commit;



--EMBARQUE SHIPMENTS

delete from CXRJ.REL_CSC_PAÍS_FORN_EMBARQUE;
commit;
for cur_emb in (
SELECT
  RESULT_UNION.FORN FORNEC,
  INSTR('BH;SP;RJ', ESCRIT) ORDEM,
  ESCRIT,
  DIV,
  SUM(NVL(QTD1,0)) QTD1,
  SUM(NVL(QTD2,0)) QTD2,
  SUM(NVL(PR1,0)) PR1,
  SUM(NVL(PR2,0)) PR2,
  SUM(NVL(RES1,0)) RES1,
  SUM(NVL(RES2,0)) RES2
FROM
       (
        SELECT
	  USU.FORNECEDOR FORN,
	  SUBSTR(EMB_F.PED_REF,1,2) ESCRIT,
	  SUBSTR(EMB_F.PED_REF,3,1) TIPO,
	  SUBSTR(EMB_F.PED_REF,4,1) DIV,
	  EMB_F.QUANTIDADE QTD1,
	  0 QTD2,
	  EMB_F.VALOR PR1,
	  0 PR2,
	  (NVL(EMB_F.RESULT1,0) + NVL(EMB_F.RESULT2,0) + NVL(EMB_F.RESULT3,0) + NVL(EMB_F.RESULT4,0) + NVL(EMB_F.RESULT5,0) )RES1,
	  0 RES2
        FROM
               (
 		SELECT
		  PED.REF, PED.FORNECEDOR
		FROM
		   PED_ITEM, PED, CIA CIAF, CIA CIAU, CIA CIAI
		WHERE
		   PED.REF = PED_ITEM.PED_REF     AND
		   PED.REF LIKE ESCRITÓRIO        AND
		   PED.REF LIKE MODALIDADE        AND
		   PED.REF LIKE DIVISÃO           AND
		   PED.REF LIKE SUBDIVIS          AND
	           PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
		   PED.FORNECEDOR = CIAF.COD(+) AND
                   PED.IMP = CIAI.COD(+) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
		   NVL(CIAF.F_COD,'%') like FORNEC AND
                   NVL(CIAI.F_COD,'%') like COMPRADOR AND
		   NVL(CIAU.F_COD,'%') like USUARIO AND
   	   	   NVL(PED.PAÍS_DESTINO,'%') like PAÍSES
		GROUP BY
                   PED.REF, PED.FORNECEDOR
               )USU, EMB_F
        WHERE
          USU.REF = EMB_F.PED_REF                         AND
          EMB_F.BL_DATA >=TO_DATE(DATA_INI1,'DD/MM/YYYY') AND
          EMB_F.BL_DATA <=TO_DATE(DATA_FIM1,'DD/MM/YYYY')
UNION ALL
        SELECT
	  USU.FORNECEDOR FORN,
	  SUBSTR(EMB_F.PED_REF,1,2) ESCRIT,
	  SUBSTR(EMB_F.PED_REF,3,1) TIPO,
	  SUBSTR(EMB_F.PED_REF,4,1) DIV,
	  0 QTD1,
	  EMB_F.QUANTIDADE QTD2,
	  0 PR1,
	  EMB_F.VALOR PR2,
	  0 RES1,
	  (NVL(EMB_F.RESULT1,0) + NVL(EMB_F.RESULT2,0) + NVL(EMB_F.RESULT3,0) + NVL(EMB_F.RESULT4,0) + NVL(EMB_F.RESULT5,0) )RES2
        FROM
               (
 		SELECT
		  PED.REF, PED.FORNECEDOR
		FROM
		   PED_ITEM, PED, CIA CIAF, CIA CIAU, CIA CIAI
		WHERE
		   PED.REF = PED_ITEM.PED_REF     AND
		   PED.REF LIKE ESCRITÓRIO        AND
		   PED.REF LIKE MODALIDADE        AND
		   PED.REF LIKE DIVISÃO           AND
		   PED.REF LIKE SUBDIVIS          AND
	           PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
		   PED.FORNECEDOR = CIAF.COD(+) AND
                   PED.IMP = CIAI.COD(+) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
		   NVL(CIAF.F_COD,'%') like FORNEC AND
                   NVL(CIAI.F_COD,'%') like COMPRADOR AND
		   NVL(CIAU.F_COD,'%') like USUARIO AND
   	   	   NVL(PED.PAÍS_DESTINO,'%') like PAÍSES
		GROUP BY
                   PED.REF, PED.FORNECEDOR
               )USU, EMB_F
        WHERE
          USU.REF = EMB_F.PED_REF                         AND
          EMB_F.BL_DATA >=TO_DATE(DATA_INI2,'DD/MM/YYYY') AND
          EMB_F.BL_DATA <=TO_DATE(DATA_FIM2,'DD/MM/YYYY')
       ) RESULT_UNION
WHERE
  RESULT_UNION.TIPO = 'P' OR
  RESULT_UNION.TIPO = 'C'
GROUP BY
  FORN,
  ESCRIT,
  DIV
HAVING NOT
  (
  SUM(NVL(QTD1,0)) =0 AND
  SUM(NVL(QTD2,0)) =0 AND
  SUM(NVL(PR1,0)) =0 AND
  SUM(NVL(PR2,0)) =0 AND
  SUM(NVL(RES1,0)) =0 AND
  SUM(NVL(RES2,0)) =0)
ORDER BY
  RESULT_UNION.FORN,
  ESCRIT
)loop
	select CIA.F_COD into CUR_emb.FORNEC from CXRJ.CIA where CIA.COD = CUR_emb.FORNEC;
	insert into CXRJ.REL_CSC_PAÍS_FORN_EMBARQUE (CHAVE, ORDEM, ESCRIT, DIV,QTD1, QTD2, PR1, PR2, RES1,RES2) VALUES (CUR_emb.FORNEC, CUR_emb.ORDEM, CUR_emb.ESCRIT, CUR_emb.DIV,CUR_emb.QTD1, CUR_emb.QTD2, CUR_emb.PR1, CUR_emb.PR2, CUR_emb.RES1,CUR_emb.RES2);
end loop;

commit;

-- RESULT

delete from CXRJ.REL_CSC_PAÍS_FORN_RESULT;
commit;
for cur_result in (
SELECT
  R.FORN FORNECEDOR,
  INSTR('BH;SP;RJ', SUBSTR(R.PED_REF,1,2)) AS ORDEM,
  SUBSTR(R.PED_REF,1,2) ESCRIT,
  SUBSTR(R.PED_REF,4,1) DIV,
  SUM(R.R1) RES1 ,
  SUM(R.R2) RES2
FROM
        (
        SELECT
	   USU.FORNECEDOR FORN,
	   RV.PED_REF,
	   RV.EMB_SEQ,
	   RV.SEQ,
	   NVL(RV.RES,0) R1,
	   0 R2
	FROM
              (
 		SELECT
		  PED.REF, PED.FORNECEDOR
		FROM
		   PED_ITEM, PED, CIA CIAF, CIA CIAU, CIA CIAI
		WHERE
		   PED.REF = PED_ITEM.PED_REF     AND
		   PED.REF LIKE ESCRITÓRIO        AND
		   PED.REF LIKE MODALIDADE        AND
		   PED.REF LIKE DIVISÃO           AND
		   PED.REF LIKE SUBDIVIS          AND
	           PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
		   PED.FORNECEDOR = CIAF.COD(+) AND
                   PED.IMP = CIAI.COD(+) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
		   NVL(CIAF.F_COD,'%') like FORNEC AND
                   NVL(CIAI.F_COD,'%') like COMPRADOR AND
		   NVL(CIAU.F_COD,'%') like USUARIO AND
   	   	   NVL(PED.PAÍS_DESTINO,'%') like PAÍSES
		GROUP BY
                   PED.REF, PED.FORNECEDOR
               )USU, RESULT_VERTICAL RV, EMB_F
	WHERE
		USU.REF = RV.PED_REF AND
		RV.PED_REF = EMB_F.PED_REF  AND
		RV.EMB_SEQ = EMB_F.SEQ  AND
		RV.DT >=TO_DATE(DATA_INI1,'DD/MM/YYYY') AND
		RV.DT <=TO_DATE(DATA_FIM1,'DD/MM/YYYY')
UNION ALL
	SELECT
	   USU.FORNECEDOR FORN,
	   RV.PED_REF,
	   RV.EMB_SEQ,
	   RV.SEQ,
	   0 R1,
	   NVL(RV.RES,0) R2
	FROM
              (
 		SELECT
		  PED.REF, PED.FORNECEDOR
		FROM
		   PED_ITEM, PED, CIA CIAF, CIA CIAU, CIA CIAI
		WHERE
		   PED.REF = PED_ITEM.PED_REF     AND
		   PED.REF LIKE ESCRITÓRIO        AND
		   PED.REF LIKE MODALIDADE        AND
		   PED.REF LIKE DIVISÃO           AND
		   PED.REF LIKE SUBDIVIS          AND
	           PED_ITEM.USUÁRIO_FINAL = CIAU.COD (+) AND
		   PED.FORNECEDOR = CIAF.COD(+) AND
                   PED.IMP = CIAI.COD(+) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) >= DECODE(SUBSTR(PEDIDOINI,6,1), 9, SUBSTR(PEDIDOINI,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOINI,1,5) || '20' || SUBSTR(PEDIDOINI,-8)) AND
                   DECODE(SUBSTR(PED.REF,6,1), 9, SUBSTR(PED.REF,1,5) || '19' || SUBSTR(PED.REF,-8) , SUBSTR(PED.REF,1,5) || '20' || SUBSTR(PED.REF,-8)) <= DECODE(SUBSTR(PEDIDOFIM,6,1), 9, SUBSTR(PEDIDOFIM,1,5) || '19' || SUBSTR(PEDIDOINI,-8) , SUBSTR(PEDIDOFIM,1,5) || '20' || SUBSTR(PEDIDOFIM,-8)) AND
		   NVL(CIAF.F_COD,'%') like FORNEC AND
                   NVL(CIAI.F_COD,'%') like COMPRADOR AND
		   NVL(CIAU.F_COD,'%') like USUARIO AND
   	   	   NVL(PED.PAÍS_DESTINO,'%') like PAÍSES
		GROUP BY
                   PED.REF, PED.FORNECEDOR
               )USU, RESULT_VERTICAL RV, EMB_F
	WHERE
		USU.REF = RV.PED_REF AND
		RV.PED_REF = EMB_F.PED_REF  AND
		RV.EMB_SEQ = EMB_F.SEQ  AND
		RV.DT >=TO_DATE(DATA_INI2,'DD/MM/YYYY') AND
		RV.DT <=TO_DATE(DATA_FIM2,'DD/MM/YYYY')
			)R
GROUP BY
	R.FORN,
	SUBSTR(R.PED_REF,1,2),
	SUBSTR(R.PED_REF,4,1)
HAVING NOT (SUM(NVL(R1,0)) =0 AND SUM(NVL(R2,0)) =0)
) loop
	select CIA.F_COD into CUR_result.FORNECEDOR from CXRJ.CIA where CIA.COD = CUR_result.FORNECEDOR;
	insert into CXRJ.REL_CSC_PAÍS_FORN_RESULT (CHAVE, ORDEM, ESCRIT, DIV,RES1,RES2) VALUES (cur_result.FORNECEDOR, cur_result.ORDEM, cur_result.ESCRIT, cur_result.DIV, cur_result.RES1,cur_result.RES2);
	end loop;
	commit;
end fornecedor;
end REL_COMP_SINT_CORP;
/