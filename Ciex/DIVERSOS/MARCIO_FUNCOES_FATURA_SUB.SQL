CREATE OR REPLACE FUNCTION SUB_TOTAL_LIQ (SEQ IN NUMBER, DOC IN NUMBER) return number IS
VALOR number;
CC NUMBER;
SOMA NUMBER;
SOMA_AUX NUMBER;

cursor C_REC is SELECT DOC_SEQ, SEQ_ITEM, FAMÍLIA, PESO_LÍQUIDO FROM DOC_FATURA_DET WHERE DOC_SEQ = DOC ORDER BY SEQ_ITEM;
V_REC C_REC%ROWTYPE;

BEGIN
CC:=0;
SOMA:=0;
OPEN C_REC;
WHILE CC < SEQ LOOP

	IF V_REC.FAMÍLIA IS NULL AND NOT V_REC.PESO_LÍQUIDO IS NULL THEN
		SOMA := SOMA + V_REC.PESO_LÍQUIDO;
	ELSE
		SOMA_AUX := SOMA;
		SOMA:=0;
	END IF;
FETCH C_REC INTO V_REC;	 
CC:= V_REC.SEQ_ITEM;

END LOOP;

IF NVL(SOMA,'') <> '' THEN
 	SOMA_AUX := SOMA;
END IF;
IF (SEQ = CC AND V_REC.PESO_LÍQUIDO IS NULL AND SOMA > 0) THEN
	VALOR:= SOMA;
ELSE
	VALOR:= NULL;
END IF;

CLOSE C_REC;

RETURN (VALOR);
END SUB_TOTAL_LIQ;
/

CREATE OR REPLACE FUNCTION SUB_TOTAL_PREC (SEQ IN NUMBER, DOC IN NUMBER) return number IS
VALOR number;
CC NUMBER;
SOMA NUMBER;
SOMA_AUX NUMBER;

cursor C_REC is SELECT DOC_SEQ, SEQ_ITEM, FAMÍLIA, PREÇO_UNIT, PESO_LÍQUIDO FROM DOC_FATURA_DET WHERE DOC_SEQ = DOC ORDER BY SEQ_ITEM;
V_REC C_REC%ROWTYPE;

BEGIN
CC:=0;
SOMA:=0;
OPEN C_REC;
WHILE CC < SEQ LOOP

	IF V_REC.FAMÍLIA IS NULL AND NOT V_REC.PREÇO_UNIT IS NULL THEN
		SOMA := SOMA + (V_REC.PREÇO_UNIT* V_REC.PESO_LÍQUIDO);
	ELSE
		SOMA_AUX := SOMA;
		SOMA:=0;
	END IF;
FETCH C_REC INTO V_REC;	 
CC:= V_REC.SEQ_ITEM;

END LOOP;

IF NVL(SOMA,'') <> '' THEN
 	SOMA_AUX := SOMA;
END IF;
IF (SEQ = CC AND V_REC.PREÇO_UNIT IS NULL AND SOMA > 0) THEN
	VALOR:= SOMA;
ELSE
	VALOR:= NULL;
END IF;

CLOSE C_REC;

RETURN (VALOR);
END SUB_TOTAL_PREC;
/

CREATE OR REPLACE FUNCTION SUB_TOTAL_VOL (SEQ IN NUMBER, DOC IN NUMBER) return number IS
VALOR number;
CC NUMBER;
SOMA NUMBER;
SOMA_AUX NUMBER;

cursor C_REC is SELECT DOC_SEQ, SEQ_ITEM, FAMÍLIA, VOLUME FROM DOC_FATURA_DET WHERE DOC_SEQ = DOC ORDER BY SEQ_ITEM;
V_REC C_REC%ROWTYPE;

BEGIN
CC:=0;
SOMA:=0;
OPEN C_REC;
WHILE CC < SEQ LOOP

	IF V_REC.FAMÍLIA IS NULL AND NOT V_REC.VOLUME IS NULL THEN
		SOMA := SOMA + V_REC.VOLUME;
	ELSE
		SOMA_AUX := SOMA;
		SOMA:=0;
	END IF;
FETCH C_REC INTO V_REC;	 
CC:= V_REC.SEQ_ITEM;

END LOOP;

IF NVL(SOMA,'') <> '' THEN
 	SOMA_AUX := SOMA;
END IF;
IF (SEQ = CC AND V_REC.VOLUME IS NULL AND SOMA > 0) THEN
	VALOR:= SOMA;
ELSE
	VALOR:= NULL;
END IF;

CLOSE C_REC;

RETURN (VALOR);
END SUB_TOTAL_VOL;
/